<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Presentation</title>
  <style>
    @font-face {
        font-family: 'BMEULJIRO';
        src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_twelve@1.0/BMEULJIRO.woff') format('woff');
        font-weight: normal;
        font-style: normal;
    }
    @font-face {
        font-family: 'ChosunGs';
        src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_20-04@1.0/ChosunGs.woff') format('woff');
        font-weight: normal;
        font-style: normal;
    }
    body {
      font-family: 'ChosunGs', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 50px;
      background-color: #f0f0f0;
      color: #333;
    }

    /* Export mode: ì›¹ ì „ìš© ë²„íŠ¼ë“¤ë§Œ ìˆ¨ê¸°ê¸° (TOCì™€ ë ˆì´ì € í¬ì¸í„°ëŠ” ìœ ì§€) */
    .export-mode #editor-toggle,
    .export-mode #lock-toggle,
    .export-mode #home-button,
    .export-mode #export-button,
    .export-mode #editor-wrapper {
      display: none !important;
    }

    /* PDF Export mode: ëª¨ë“  ë²„íŠ¼ê³¼ ìƒí˜¸ì‘ìš© ìš”ì†Œ ìˆ¨ê¸°ê¸° + ë°°ê²½ ì„¤ì • */
    .pdf-export-mode #toc-toggle,
    .pdf-export-mode #laser-toggle,
    .pdf-export-mode #editor-toggle,
    .pdf-export-mode #lock-toggle,
    .pdf-export-mode #home-button,
    .pdf-export-mode #export-button,
    .pdf-export-mode #editor-wrapper,
    .pdf-export-mode #toc-nav {
      display: none !important;
    }

    /* PDF Export mode: ë°°ê²½ ì œê±°í•˜ê³  í°ìƒ‰ ë°°ê²½ë§Œ ì‚¬ìš© */
    .pdf-export-mode body {
      background-color: #ffffff !important;
      padding: 0 !important;
    }

    .pdf-export-mode .content-wrapper {
      max-width: none !important;
      margin: 0 !important;
      padding: 40px !important;
      border-radius: 0 !important;
      box-shadow: none !important;
      background: #ffffff !important;
    }

    /* PDF Export mode: ëª¨ë“  ì• ë‹ˆë©”ì´ì…˜ ë¹„í™œì„±í™” */
    .pdf-export-mode h1,
    .pdf-export-mode h2,
    .pdf-export-mode h3,
    .pdf-export-mode h4,
    .pdf-export-mode h5,
    .pdf-export-mode h6 {
      opacity: 1 !important;
      transform: translateY(0) !important;
      transition: none !important;
    }

    .pdf-export-mode p .word {
      opacity: 1 !important;
      transition: none !important;
    }

    .pdf-export-mode strong::after {
      transform: scaleX(1) !important;
      transition: none !important;
    }

    .content-wrapper {
        max-width: 800px;
        margin: 0 auto;
        background: #fff;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    #toc-toggle {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1001;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: left 0.4s ease;
    }
    #toc-nav {
      position: fixed;
      top: 0;
      left: -320px;
      width: 280px;
      height: 100%;
      background: #f8f8f8;
      border-right: 1px solid #e7e7e7;
      padding: 80px 20px 20px 20px;
      overflow-y: auto;
      z-index: 1000;
      transition: left 0.4s ease;
    }
    body.toc-open #toc-nav {
      left: 0;
    }
    body.toc-open #toc-toggle {
      left: 300px;
    }
    #laser-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1001;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0;
    }
    #laser-toggle.active {
      background-color: #fff0f0;
      border-color: #ff8080;
    }
    #editor-toggle {
      position: fixed;
      top: 20px;
      right: 70px;
      z-index: 1001;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0;
    }
    #editor-toggle.active {
      background-color: #e6f7ff;
      border-color: #91d5ff;
    }
    #lock-toggle {
      position: fixed;
      top: 20px;
      right: 120px;
      z-index: 1001;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0;
    }
    #lock-toggle.locked {
      background-color: #fff4e6;
      border-color: #ffad33;
    }
    #lock-toggle.unlocked {
      background-color: #f0f9ff;
      border-color: #91d5ff;
    }
    #home-button {
      position: fixed;
      top: 20px;
      left: 70px;
      z-index: 1001;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0;
      text-decoration: none;
      transition: opacity 0.3s ease;
    }
    body.toc-open #home-button {
      opacity: 0;
      pointer-events: none;
    }
    #export-pdf-button {
      position: fixed;
      top: 20px;
      right: 120px;
      z-index: 1001;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0;
    }
    #export-pdf-button.loading {
      cursor: wait;
      background-color: #f0f0f0;
    }
    #export-pdf-button.loading svg {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    #editor-wrapper {
      position: fixed;
      left: 0;
      top: 0;
      width: 40vw;
      height: 100vh;
      background: #fdfdfd;
      z-index: 1002;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      transform: translateX(-100%);
      transition: transform 0.4s ease;
      display: flex;
      flex-direction: column;
    }
    body.editor-mode #editor-wrapper {
      transform: translateX(0);
    }
    body.editor-mode #preview-container {
      margin-left: 40vw;
    }
    
    #editor-container {
      position: relative;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    #editor-header {
      padding: 10px 15px;
      background: #f0f0f0;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: sans-serif;
      font-size: 14px;
      font-weight: bold;
      color: #333;
    }
    .header-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #help-button {
      background: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      font-weight: bold;
      color: #666;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    #help-button:hover {
      background: #e0e0e0;
      color: #333;
    }

    .header-buttons {
      display: flex;
      gap: 8px;
    }

    #save-button {
      padding: 5px 12px;
      font-size: 13px;
      font-weight: bold;
      color: #fff;
      background-color: #28a745;
      border: 1px solid #28a745;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #save-button:hover {
      background-color: #218838;
    }

    #ai-toggle-button {
      padding: 5px 12px;
      font-size: 13px;
      font-weight: bold;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    #ai-toggle-button.ai-enabled {
      background-color: #2196F3;
      color: white;
      border: 1px solid #2196F3;
    }

    #ai-toggle-button.ai-enabled:hover {
      background-color: #1976D2;
      border-color: #1976D2;
    }

    #ai-toggle-button.ai-disabled {
      background-color: #f8f9fa;
      color: #6c757d;
      border: 1px solid #dee2e6;
    }

    #ai-toggle-button.ai-disabled:hover {
      background-color: #e9ecef;
    }

    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: none;
      border-radius: 8px;
      width: 500px;
      max-width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }

    .close:hover,
    .close:focus {
      color: #000;
    }

    .form-group {
      margin: 15px 0;
      position: relative;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input[type="password"],
    .form-group input[type="text"] {
      width: 100%;
      padding: 8px 40px 8px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      background: white;
      box-sizing: border-box;
    }

    .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      background: white;
      box-sizing: border-box;
    }

    .show-password {
      position: absolute;
      right: 8px;
      top: 75%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      padding: 4px;
      color: #666;
      z-index: 1;
    }

    .show-password:hover {
      color: #333;
    }

    .modal-buttons {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .modal-buttons button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    #save-api-key {
      background-color: #2196F3;
      color: white;
    }

    #save-api-key:hover {
      background-color: #1976D2;
    }

    #cancel-api-key {
      background-color: #f0f0f0;
      color: #333;
    }

    #cancel-api-key:hover {
      background-color: #e0e0e0;
    }

    .api-key-help {
      margin-top: 15px;
      color: #666;
      line-height: 1.4;
    }

    .api-key-help a {
      color: #2196F3;
      text-decoration: none;
    }

    .api-key-help a:hover {
      text-decoration: underline;
    }

    /* ë„ì›€ë§ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .help-section {
      margin: 20px 0;
    }

    .help-section h3 {
      margin: 15px 0 10px 0;
      color: #333;
      font-size: 16px;
    }

    .help-section ul {
      margin: 0;
      padding-left: 20px;
    }

    .help-section li {
      margin: 8px 0;
      line-height: 1.4;
    }

    kbd {
      background-color: #f1f3f4;
      border: 1px solid #dadce0;
      border-radius: 3px;
      box-shadow: 0 1px 1px rgba(0,0,0,0.1);
      color: #202124;
      display: inline-block;
      font-family: monospace;
      font-size: 11px;
      line-height: 16px;
      margin: 0 2px;
      padding: 0 4px;
      text-align: center;
      vertical-align: middle;
    }

    #close-help {
      background-color: #2196F3;
      color: white;
    }

    #close-help:hover {
      background-color: #1976D2;
    }

    /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-8px);
      }
      60% {
        transform: translateY(-4px);
      }
    }

    #editor {
      flex-grow: 1;
      border: none;
      padding: 15px;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.5;
      resize: none;
      background-color: #fdfdfd;
      position: relative;
      z-index: 2;
    }
    #editor:focus {
      outline: none;
    }
    
    #ghost-text {
      position: absolute;
      top: 15px;
      left: 15px;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.5;
      color: #888;
      pointer-events: none;
      white-space: pre-wrap;
      word-wrap: break-word;
      z-index: 1;
      opacity: 0.7;
      background-color: transparent;
      width: calc(100% - 30px);
      height: calc(100% - 30px);
      overflow: hidden;
      padding: 0;
      margin: 0;
      border: none;
    }
    
    #ai-suggestion-panel {
      position: absolute;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 1003;
      max-width: 300px;
      display: none;
    }
    
    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      font-size: 13px;
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .suggestion-item:hover,
    .suggestion-item.selected {
      background-color: #e6f7ff;
    }
    
    .suggestion-loading {
      padding: 12px;
      text-align: center;
      color: #666;
      font-style: italic;
    }

    #toc-nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #toc-nav a {
      text-decoration: none;
      color: #333;
      display: block;
      padding: 5px 0;
      transition: color 0.2s;
    }
    #toc-nav a:hover {
      color: #007acc;
    }
    .toc-level-1 { font-weight: bold; margin-top: 10px; }
    .toc-level-2 { padding-left: 15px; }
    .toc-level-3 { padding-left: 30px; }

    .control-button {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0;
    }
    .control-button.loading {
      cursor: wait;
      background-color: #f0f0f0;
    }
    .control-button.loading svg {
      animation: spin 1s linear infinite;
    }

    #laser-canvas {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 9999;
      pointer-events: none; /* Allows clicks to pass through */
      width: 100vw;
      height: 100vh;
    }

    body.laser-mode-on {
      user-select: none;
      -webkit-user-select: none;
      /* cursor: crosshair; */
    }

    h1, h2, h3, h4, h5, h6 {
      font-family: 'BMEULJIRO';
      opacity: 0;
      transform: translateY(30px);
      transition: opacity 0.6s ease-out, transform 0.6s ease-out;
    }
    h1.visible, h2.visible, h3.visible, h4.visible, h5.visible, h6.visible {
      opacity: 1;
      transform: translateY(0);
    }
    p {
      /* The script will wrap words in spans, so we animate the spans */
    }
    p .word {
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
    }
    strong {
        position: relative;
        font-weight: bold;
        z-index: 1;
    }
    strong::after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 1px;
      width: 100%;
      height: 0.4em;
      background-color: rgba(255, 229, 100, 0.7);
      z-index: -1;
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.4s ease-out;
    }
    strong.visible::after {
      transform: scaleX(1);
    }
    em {
        font-style: italic;
    }
    
    @keyframes flash-highlight {
      from {
        background-color: rgba(255, 255, 0, 0.4);
      }
      to {
        background-color: transparent;
      }
    }

    .flash-highlight {
      animation: flash-highlight 1s ease-out;
    }

    #export-button {
      position: fixed;
      top: 20px;
      right: 170px;
      z-index: 1001;
    }

    .control-group {
      position: relative;
    }

    #export-options {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 1002;
      width: 150px;
    }

    #export-options a {
      display: block;
      padding: 8px 12px;
      color: #333;
      text-decoration: none;
      font-size: 14px;
    }

    #export-options a:hover {
      background-color: #f0f0f0;
    }

    /* Table styles */
    table {
      border-collapse: collapse;
      width: 100%;
      margin: 20px 0;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 6px;
      overflow: hidden;
    }

    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    thead th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #333;
      position: sticky;
      top: 0;
    }

    tbody tr {
      transition: background-color 0.15s ease;
    }

    tbody tr:hover {
      background-color: #f8f9fa;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    /* Striped rows */
    tbody tr:nth-child(even) {
      background-color: #fafbfc;
    }

    tbody tr:nth-child(even):hover {
      background-color: #f1f3f4;
    }

    /* Center align for specific columns if needed */
    td.center, th.center {
      text-align: center;
    }

    td.right, th.right {
      text-align: right;
    }

    /* Responsive table */
    @media (max-width: 768px) {
      table {
        font-size: 12px;
      }
      
      th, td {
        padding: 8px 10px;
      }
    }

    /* PDF export specific table styles */
    .pdf-export-mode table {
      box-shadow: none;
      border: 1px solid #ddd;
    }

    .pdf-export-mode tbody tr:hover {
      background-color: transparent;
    }
  </style>
</head>
<body>
  <div id="editor-wrapper">
    <div id="editor-header">
      <div class="header-title">
        <span>AI ê¸€ì“°ê¸° ì—ë””í„°</span>
        <button id="help-button" title="ë‹¨ì¶•í‚¤ ë„ì›€ë§">?</button>
      </div>
      <div class="header-buttons">
        <button id="ai-toggle-button" class="ai-disabled">AI ë¹„í™œì„±í™”</button>
        <button id="save-button">Save</button>
      </div>
    </div>
    <div id="editor-container">
      <div id="ghost-text"></div>
      <textarea id="editor"></textarea>
      <div id="ai-suggestion-panel">
        <div class="suggestion-loading">AI ì¶”ì²œì„ ìƒì„±ì¤‘...</div>
      </div>
    </div>
  </div>

  <!-- API í‚¤ ì…ë ¥ ëª¨ë‹¬ -->
  <div id="api-key-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>AI ì„¤ì •</h2>
      <p>AI ì¶”ì²œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ API í‚¤ì™€ ëª¨ë¸ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
      
      <div class="form-group">
        <label for="ai-provider-select">AI ì œê³µì:</label>
        <select id="ai-provider-select">
          <option value="openai">OpenAI</option>
          <option value="anthropic">Anthropic (Claude)</option>
          <option value="google">Google (Gemini)</option>
          <option value="openai-compatible">OpenAI í˜¸í™˜ API</option>
        </select>
      </div>

      <div class="form-group">
        <label for="ai-model-select">AI ëª¨ë¸:</label>
        <select id="ai-model-select">
          <option value="gpt-4o-mini">GPT-4o Mini (ì¶”ì²œ)</option>
          <option value="gpt-4o">GPT-4o</option>
          <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
          <option value="gpt-4-turbo">GPT-4 Turbo</option>
        </select>
      </div>

      <div class="form-group" id="custom-model-group" style="display: none;">
        <label for="custom-model-input">ì§ì ‘ ì…ë ¥í•œ ëª¨ë¸ëª…:</label>
        <input type="text" id="custom-model-input" placeholder="ì˜ˆ: gpt-4-turbo-preview, claude-3-opus-20240229">
        <small style="color: #666; font-size: 12px; display: block; margin-top: 4px;">
          ì‹¤ì œ APIì—ì„œ ì‚¬ìš©í•˜ëŠ” ì •í™•í•œ ëª¨ë¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”
        </small>
      </div>

      <div class="form-group" id="custom-endpoint-group" style="display: none;">
        <label for="custom-endpoint-input">API ì—”ë“œí¬ì¸íŠ¸:</label>
        <input type="text" id="custom-endpoint-input" placeholder="https://api.example.com/v1">
      </div>
      
      <div class="form-group">
        <label for="api-key-input">API í‚¤:</label>
        <input type="password" id="api-key-input" placeholder="API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        <button type="button" id="show-api-key" class="show-password">ğŸ‘</button>
      </div>
      
      <details style="margin: 20px 0;">
        <summary style="cursor: pointer; font-weight: bold; padding: 8px 0;">ğŸ“ í”„ë¡¬í”„íŠ¸ ì»¤ìŠ¤í„°ë§ˆì´ì§• (ì„ íƒì‚¬í•­)</summary>
        <div style="margin-top: 15px;">
          <div class="form-group">
            <label for="continue-prompt">ê³„ì† ì‘ì„± í”„ë¡¬í”„íŠ¸:</label>
            <textarea id="continue-prompt" rows="8" style="width: 100%; max-width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: 'Courier New', monospace; resize: vertical; min-height: 120px; box-sizing: border-box;"></textarea>
            <button type="button" id="reset-continue-prompt" style="margin-top: 5px; padding: 4px 8px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 3px; cursor: pointer; font-size: 12px;">ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”</button>
          </div>
          
          <div class="form-group">
            <label for="improve-prompt">ê°œì„  ëª¨ë“œ í”„ë¡¬í”„íŠ¸:</label>
            <textarea id="improve-prompt" rows="8" style="width: 100%; max-width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: 'Courier New', monospace; resize: vertical; min-height: 120px; box-sizing: border-box;"></textarea>
            <button type="button" id="reset-improve-prompt" style="margin-top: 5px; padding: 4px 8px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 3px; cursor: pointer; font-size: 12px;">ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”</button>
          </div>
          
          <div style="margin-top: 10px; font-size: 12px; color: #666;">
            <p><strong>ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜:</strong></p>
            <ul style="margin: 5px 0; padding-left: 20px;">
              <li><code>{text}</code> - ì „ì²´ ë¬¸ì„œ ë‚´ìš©</li>
              <li><code>{beforeCursor}</code> - ì»¤ì„œ ì•ì˜ ë‚´ìš©</li>
              <li><code>{afterCursor}</code> - ì»¤ì„œ ë’¤ì˜ ë‚´ìš©</li>
              <li><code>{selectedText}</code> - ì„ íƒëœ í…ìŠ¤íŠ¸ (ê°œì„  ëª¨ë“œì—ì„œë§Œ)</li>
            </ul>
          </div>
        </div>
      </details>
      
      <div class="modal-buttons">
        <button id="save-api-key">ì €ì¥</button>
        <button id="cancel-api-key">ì·¨ì†Œ</button>
      </div>
      
      <div class="api-key-help">
        <div id="help-text-openai">
          <small>
            API í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©° ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>
            <a href="https://platform.openai.com/api-keys" target="_blank">OpenAIì—ì„œ API í‚¤ ë°œê¸‰ë°›ê¸°</a>
          </small>
        </div>
        <div id="help-text-anthropic" style="display: none;">
          <small>
            API í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©° ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>
            <a href="https://console.anthropic.com/" target="_blank">Anthropicì—ì„œ API í‚¤ ë°œê¸‰ë°›ê¸°</a>
          </small>
        </div>
        <div id="help-text-google" style="display: none;">
          <small>
            API í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©° ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>
            <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studioì—ì„œ API í‚¤ ë°œê¸‰ë°›ê¸°</a>
          </small>
        </div>
        <div id="help-text-openai-compatible" style="display: none;">
          <small>
            OpenAI í˜¸í™˜ APIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì—”ë“œí¬ì¸íŠ¸ì™€ API í‚¤ë¥¼ ì„¤ì •í•˜ì„¸ìš”.<br>
            (ì˜ˆ: Ollama, LocalAI, vLLM ë“±)
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- ë„ì›€ë§ ëª¨ë‹¬ -->
  <div id="help-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>ë‹¨ì¶•í‚¤ ë„ì›€ë§</h2>
      <div class="help-section">
        <h3>ğŸ¤– AI ì¶”ì²œ ê¸°ëŠ¥</h3>
        <ul>
          <li><kbd>âŒ˜</kbd> + <kbd>âŒƒ</kbd> + <kbd>â†’</kbd> : AI ì¶”ì²œ ìš”ì²­</li>
          <li><kbd>â†‘</kbd> / <kbd>â†“</kbd> : ì¶”ì²œ í•­ëª© íƒìƒ‰</li>
          <li><kbd>Tab</kbd> : ì„ íƒëœ ì¶”ì²œ ì ìš©</li>
          <li><kbd>Esc</kbd> : ì¶”ì²œ íŒ¨ë„ ë‹«ê¸°</li>
        </ul>
      </div>
      <div class="help-section">
        <h3>âœï¸ í¸ì§‘ ê¸°ëŠ¥</h3>
        <ul>
          <li><kbd>âŒ˜</kbd> + <kbd>Z</kbd> : ì‹¤í–‰ ì·¨ì†Œ (Undo)</li>
          <li><kbd>âŒ˜</kbd> + <kbd>â‡§</kbd> + <kbd>Z</kbd> : ë‹¤ì‹œ ì‹¤í–‰ (Redo)</li>
          <li><kbd>Tab</kbd> : 4ì¹¸ ë“¤ì—¬ì“°ê¸° (AI ì¶”ì²œì´ ì—†ì„ ë•Œ)</li>
        </ul>
      </div>
      <div class="help-section">
        <h3>ğŸ’¡ AI ì¶”ì²œ ëª¨ë“œ</h3>
        <ul>
          <li><strong>ê³„ì† ì‘ì„± ëª¨ë“œ:</strong> ì»¤ì„œ ìœ„ì¹˜ì—ì„œ ì¶”ì²œ ìš”ì²­</li>
          <li><strong>ê°œì„  ëª¨ë“œ:</strong> í…ìŠ¤íŠ¸ ì„ íƒ í›„ ì¶”ì²œ ìš”ì²­</li>
        </ul>
      </div>
      <div class="modal-buttons">
        <button id="close-help">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- íŒŒì¼ ì ê¸ˆ ì„¤ì • ëª¨ë‹¬ -->
  <div id="file-lock-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>íŒŒì¼ ì ê¸ˆ ì„¤ì •</h2>
      <p>ì´ íŒŒì¼ì„ ë¹„ë°€ë²ˆí˜¸ë¡œ ë³´í˜¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
      
      <div class="form-group">
        <label for="lock-password-input">ë¹„ë°€ë²ˆí˜¸:</label>
        <input type="password" id="lock-password-input" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ìµœì†Œ 4ì)">
        <button type="button" id="show-lock-password" class="show-password">ğŸ‘</button>
      </div>
      
      <div class="form-group">
        <label for="lock-password-confirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸:</label>
        <input type="password" id="lock-password-confirm" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”">
        <button type="button" id="show-lock-password-confirm" class="show-password">ğŸ‘</button>
      </div>
      
      <div class="modal-buttons">
        <button id="set-lock-password">íŒŒì¼ ì ê¸ˆ</button>
        <button id="remove-file-lock" style="display: none; background-color: #ff6b6b;">ì ê¸ˆ í•´ì œ</button>
        <button id="cancel-lock-settings">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <!-- íŒŒì¼ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ -->
  <div id="file-unlock-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>ğŸ”’ ì ê¸´ íŒŒì¼</h2>
      <p>ì´ íŒŒì¼ì€ ë¹„ë°€ë²ˆí˜¸ë¡œ ë³´í˜¸ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
      
      <div class="form-group">
        <label for="unlock-password-input">ë¹„ë°€ë²ˆí˜¸:</label>
        <input type="password" id="unlock-password-input" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        <button type="button" id="show-unlock-password" class="show-password">ğŸ‘</button>
      </div>
      
      <div id="unlock-error" style="color: #ff6b6b; font-size: 14px; margin-top: 8px; display: none;">
        ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      </div>
      
      <div class="modal-buttons">
        <button id="unlock-file">íŒŒì¼ ì—´ê¸°</button>
        <button id="cancel-unlock">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <div id="preview-container">
    <a id="home-button" href="/" title="Back to Home">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
    </a>
    <button id="toc-toggle">â˜°</button>
    <button id="laser-toggle" title="Toggle Laser Pointer (L)">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
    </button>
    <div id="export-button" class="control-group">
      <button id="export-trigger" class="control-button" title="Export options">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
      </button>
      <div id="export-options">
        <a href="#" id="export-html-btn">Export as HTML</a>
        <a href="#" id="export-pdf-btn">Export as PDF</a>
        <a href="#" id="export-markdown-btn">Export as Markdown</a>
      </div>
    </div>
    <button id="editor-toggle" title="Toggle Editor">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
    </button>
    <button id="lock-toggle" title="File Lock Settings">
      <svg id="lock-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><circle cx="12" cy="16" r="1"></circle><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
    </button>
    
    <nav id="toc-nav">
      {{TOC_HTML}}
    </nav>
    <div class="content-wrapper">
      {{CONTENT}}
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Export ëª¨ë“œ ê°ì§€ (ê°„ë‹¨í•˜ê²Œ)
      const isExported = document.body.classList.contains('export-mode') || 
                        !window.location.pathname.includes('/view');
      const isPdfExport = window.IS_PDF_EXPORT || document.body.classList.contains('pdf-export-mode');

      // Export ëª¨ë“œë¼ë©´ export-mode í´ë˜ìŠ¤ ì¶”ê°€ (CSSë¡œ ë²„íŠ¼ë“¤ ìˆ¨ê¹€)
      if (isExported) {
        document.body.classList.add('export-mode');
      }
      
      // PDF export ëª¨ë“œë¼ë©´ ëª¨ë“  ìƒí˜¸ì‘ìš© ê¸°ëŠ¥ ë¹„í™œì„±í™”
      if (isPdfExport) {
        document.body.classList.add('pdf-export-mode');
      }

      // ì• ë‹ˆë©”ì´ì…˜ ì´ˆê¸°í™” (í•­ìƒ ì‹¤í–‰)
      initAnimations();

      // PDF exportê°€ ì•„ë‹ ë•Œë§Œ ìƒí˜¸ì‘ìš© ê¸°ëŠ¥ í™œì„±í™”
      if (!isPdfExport) {
        initTocFeatures();
        initLaserPointer();
      }

      // Export ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ì›¹ ì „ìš© ê¸°ëŠ¥ë“¤ í™œì„±í™”
      if (!isExported) {
        initWebFeatures();
      }
    });

    // ë‹¨ì–´ë³„ë¡œ span ê°ì‹¸ê¸° (ì „ì—­ í•¨ìˆ˜ë¡œ ì´ë™)
    function wrapWordsInSpans(element) {
      const walker = document.createTreeWalker(
        element,
        NodeFilter.SHOW_TEXT,
        null,
        false
      );

      const textNodes = [];
      let node;
      while (node = walker.nextNode()) {
        if (node.textContent.trim().length > 0) {
          textNodes.push(node);
        }
      }

      textNodes.forEach(textNode => {
        const words = textNode.textContent.split(/\s+/).filter(word => word.length > 0);
        if (words.length > 0) {
          const fragment = document.createDocumentFragment();
          words.forEach((word, index) => {
            const span = document.createElement('span');
            span.className = 'word';
            span.textContent = word;
            fragment.appendChild(span);
            
            if (index < words.length - 1) {
              fragment.appendChild(document.createTextNode(' '));
            }
          });
          textNode.parentNode.replaceChild(fragment, textNode);
        }
      });
    }

    function initAnimations() {
      // PDF ëª¨ë“œì—ì„œëŠ” ì• ë‹ˆë©”ì´ì…˜ì„ ê±´ë„ˆë›°ê³  ëª¨ë“  ìš”ì†Œë¥¼ ì¦‰ì‹œ í‘œì‹œ
      if (window.IS_PDF_EXPORT || document.body.classList.contains('pdf-export-mode')) {
        // ëª¨ë“  ì œëª©ì„ ì¦‰ì‹œ í‘œì‹œ
        document.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(heading => {
          heading.classList.add('visible');
        });

        // ëª¨ë“  í…ìŠ¤íŠ¸ë¥¼ ê°ì‹¸ê³  ì¦‰ì‹œ í‘œì‹œ
        document.querySelectorAll('p').forEach(paragraph => {
          wrapWordsInSpans(paragraph);
          const words = paragraph.querySelectorAll('.word');
          words.forEach(word => {
            word.style.opacity = '1';
          });
          
          // ê°•ì¡° í…ìŠ¤íŠ¸ë„ ì¦‰ì‹œ í‘œì‹œ
          const strongs = paragraph.querySelectorAll('strong');
          strongs.forEach(strong => {
            strong.classList.add('visible');
          });
        });

        // ë¦¬ìŠ¤íŠ¸ì™€ ì œëª© ë‚´ë¶€ì˜ strong ìš”ì†Œë“¤ë„ ì¦‰ì‹œ í‘œì‹œ
        document.querySelectorAll('li strong, h1 strong, h2 strong, h3 strong, h4 strong, h5 strong, h6 strong').forEach(strong => {
          strong.classList.add('visible');
        });
        return; // ì• ë‹ˆë©”ì´ì…˜ ë¡œì§ ê±´ë„ˆë›°ê¸°
      }

      const observerOptions = {
        root: null,
        rootMargin: '0px',
        threshold: 0.1
      };

      // ì œëª© ì• ë‹ˆë©”ì´ì…˜
      const headingObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('visible');
            observer.unobserve(entry.target);
          }
        });
      }, observerOptions);

      document.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(heading => {
        headingObserver.observe(heading);
      });

      // í…ìŠ¤íŠ¸ ì• ë‹ˆë©”ì´ì…˜
      const textObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const paragraph = entry.target;
            const words = paragraph.querySelectorAll('.word');
            
            words.forEach((word, index) => {
              setTimeout(() => {
                word.style.opacity = '1';
              }, index * 100);
            });

            // ê°•ì¡° í…ìŠ¤íŠ¸ ì• ë‹ˆë©”ì´ì…˜
            const strongs = paragraph.querySelectorAll('strong');
            strongs.forEach(strong => {
              const firstWord = strong.querySelector('.word');
              if (firstWord) {
                const firstWordIndex = Array.from(words).indexOf(firstWord);
                if (firstWordIndex !== -1) {
                  setTimeout(() => {
                    strong.classList.add('visible');
                  }, firstWordIndex * 100);
                }
              }
            });

            observer.unobserve(paragraph);
          }
        });
      }, observerOptions);



      document.querySelectorAll('p').forEach(paragraph => {
        wrapWordsInSpans(paragraph);
        textObserver.observe(paragraph);
      });

      // ë¦¬ìŠ¤íŠ¸ì™€ ì œëª© ë‚´ë¶€ì˜ strong ìš”ì†Œë“¤ì—ë„ ì¦‰ì‹œ visible í´ë˜ìŠ¤ ì¶”ê°€
      document.querySelectorAll('li strong, h1 strong, h2 strong, h3 strong, h4 strong, h5 strong, h6 strong').forEach(strong => {
        strong.classList.add('visible');
      });
    }

    function initTocFeatures() {
      // TOC í† ê¸€
      const tocToggle = document.getElementById('toc-toggle');
      if (tocToggle) {
        tocToggle.addEventListener('click', () => {
          document.body.classList.toggle('toc-open');
        });
      }

      // TOC ë„¤ë¹„ê²Œì´ì…˜
      const tocNav = document.getElementById('toc-nav');
      if (tocNav) {
        tocNav.addEventListener('click', (e) => {
          if (e.target.tagName === 'A' && e.target.getAttribute('href').startsWith('#')) {
            e.preventDefault();
            const targetId = e.target.getAttribute('href').substring(1); // # ì œê±°
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
              targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
              targetElement.classList.add('flash-highlight');
              setTimeout(() => {
                targetElement.classList.remove('flash-highlight');
              }, 1000);
              document.body.classList.remove('toc-open');
            }
          }
        });
      }
    }

    // ì„¸ì…˜ IDëŠ” ì„œë²„ì—ì„œ ì¿ í‚¤ë¡œ ê´€ë¦¬ë¨
    // í´ë¼ì´ì–¸íŠ¸ì—ì„œëŠ” x-session-id í—¤ë”ë¡œ ì „ë‹¬ë°›ì€ ê°’ ì‚¬ìš©
    let sessionId = null;

    // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ UI ìƒì„±
    function createPasswordUI(filename) {
      return `
        <div style="
          max-width: 500px; 
          margin: 100px auto; 
          padding: 40px; 
          background: white; 
          border-radius: 12px; 
          box-shadow: 0 4px 20px rgba(0,0,0,0.1);
          text-align: center;
        ">
          <div style="font-size: 48px; margin-bottom: 20px;">ğŸ”’</div>
          <h2 style="color: #333; margin-bottom: 10px;">íŒŒì¼ì´ ì ê²¨ìˆìŠµë‹ˆë‹¤</h2>
          <p style="color: #666; margin-bottom: 30px;">
            <strong>${filename}</strong> íŒŒì¼ì„ ë³´ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
          </p>
          <div style="margin-bottom: 20px;">
            <input type="password" id="temp-password-input" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" 
              style="
                width: 100%; 
                padding: 12px; 
                border: 2px solid #ddd; 
                border-radius: 6px; 
                font-size: 16px; 
                box-sizing: border-box;
              " />
          </div>
          <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="temp-unlock-btn" style="
              padding: 12px 24px; 
              background: #0366d6; 
              color: white; 
              border: none; 
              border-radius: 6px; 
              cursor: pointer; 
              font-size: 16px;
            ">ë³´ê¸°</button>
            <button id="temp-cancel-btn" style="
              padding: 12px 24px; 
              background: #6c757d; 
              color: white; 
              border: none; 
              border-radius: 6px; 
              cursor: pointer; 
              font-size: 16px;
            ">ì·¨ì†Œ</button>
          </div>
          <div id="temp-error" style="
            color: #dc3545; 
            margin-top: 15px; 
            display: none;
          "></div>
        </div>
      `;
    }

    async function loadContent(currentFile) {
      if (!currentFile) {
        document.querySelector('.content-wrapper').innerHTML = '<h1>Error: No file specified.</h1>';
        return;
      }

      try {
        // ìƒˆë¡œìš´ API ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš© (ì ê¸ˆ ìƒíƒœ í™•ì¸ í¬í•¨)
        const fileResponse = await fetch(`/api/get-file?filename=${encodeURIComponent(currentFile)}`);
        if (!fileResponse.ok) throw new Error('Could not fetch file.');
        const fileData = await fileResponse.json();

        // ì ê¸´ íŒŒì¼ì´ê³  ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•œ ê²½ìš°
        if (fileData.needsPassword) {
          const passwordUI = createPasswordUI(fileData.filename);
          document.querySelector('.content-wrapper').innerHTML = passwordUI;
          document.querySelector('#toc-nav').innerHTML = '';

          // ì—ë””í„° ë¹„í™œì„±í™”
          const editorToggle = document.getElementById('editor-toggle');
          if (editorToggle) {
            editorToggle.style.display = 'none';
          }

          // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          const passwordInput = document.getElementById('temp-password-input');
          const unlockBtn = document.getElementById('temp-unlock-btn');
          const cancelBtn = document.getElementById('temp-cancel-btn');
          const errorDiv = document.getElementById('temp-error');

          const attemptUnlock = async () => {
            const password = passwordInput.value.trim();
            if (!password) {
              errorDiv.textContent = 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
              errorDiv.style.display = 'block';
              return;
            }

            try {
              const response = await fetch('/api/temporary-access', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  filename: currentFile,
                  password: password
                })
              });

              if (response.ok) {
                // ì„ì‹œ ì ‘ê·¼ ê¶Œí•œ íšë“ í›„ íŒŒì¼ ë‹¤ì‹œ ë¡œë“œ
                await loadContent(currentFile);
              } else {
                errorDiv.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                errorDiv.style.display = 'block';
              }
            } catch (error) {
              console.error('ì„ì‹œ ì ‘ê·¼ ì˜¤ë¥˜:', error);
              errorDiv.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
              errorDiv.style.display = 'block';
            }
          };

          unlockBtn.addEventListener('click', attemptUnlock);
          passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              attemptUnlock();
            }
          });
          cancelBtn.addEventListener('click', () => {
            window.location.href = '/';
          });

          // ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
          passwordInput.focus();
          return;
        }

        // ì ê¸´ íŒŒì¼ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì½˜í…ì¸  ë Œë”ë§
        if (!fileData.needsPassword && fileData.content) {
          const markdownContent = fileData.content;
          const isLocked = fileData.isLocked;

          const renderResponse = await fetch('/api/render', {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ markdown: markdownContent })
          });
          if (!renderResponse.ok) throw new Error('Failed to render markdown.');
          const rendered = await renderResponse.json();

          document.querySelector('.content-wrapper').innerHTML = rendered.contentHtml;
          document.querySelector('#toc-nav').innerHTML = rendered.tocHtml;
        }

        // ì ê¸´ íŒŒì¼ì˜ ê²½ìš° ì—ë””í„° ë¹„í™œì„±í™”
        const editorToggle = document.getElementById('editor-toggle');
        if (editorToggle) {
          if (fileData.needsPassword || fileData.isLocked) {
            editorToggle.style.display = 'none';
          } else {
            editorToggle.style.display = 'block';
          }
        }

        // ìƒˆë¡œ ë¡œë“œëœ ì½˜í…ì¸ ì— ì• ë‹ˆë©”ì´ì…˜ ì ìš©
        initAnimations();
      } catch (error) {
        console.error('Failed to load content:', error);
        document.querySelector('.content-wrapper').innerHTML = `<h2>Error loading content.</h2><p>${error.message}</p>`;
      }
    }

    function initWebFeatures() {
      const currentFile = new URLSearchParams(window.location.search).get('file');

      // ë™ì ìœ¼ë¡œ ì½˜í…ì¸  ë¡œë“œ
      loadContent(currentFile);

      // ì—ë””í„° ê¸°ëŠ¥
      const editorToggle = document.getElementById('editor-toggle');
      const saveButton = document.getElementById('save-button');
      const aiToggleButton = document.getElementById('ai-toggle-button');
      const helpButton = document.getElementById('help-button');
      const editor = document.getElementById('editor');
      const ghostText = document.getElementById('ghost-text');
      const suggestionPanel = document.getElementById('ai-suggestion-panel');
      let editorInitialized = false;
      
      // AI ì¶”ì²œ ê´€ë ¨ ë³€ìˆ˜
      let currentSuggestions = [];
      let selectedSuggestionIndex = 0;
      let suggestionDebounceTimer = null;
      let isShowingSuggestion = false;
      let suggestionMode = 'continue'; // 'continue' ë˜ëŠ” 'improve'
      let selectedTextForImprovement = '';
      
            // AI í™œì„±í™” ìƒíƒœ ê´€ë¦¬
      let isAiEnabled = false;
      let userApiKey = '';
      let aiProvider = 'openai';
      let aiModel = 'gpt-4o-mini';
      let customEndpoint = '';
      
      // Undo/Redo ì‹œìŠ¤í…œ
      let undoStack = [];
      let redoStack = [];
      let isUndoRedo = false; // undo/redo ë™ì‘ ì¤‘ì¸ì§€ í™•ì¸
      let undoSaveTimer = null; // ë””ë°”ìš´ìŠ¤ íƒ€ì´ë¨¸
      const MAX_UNDO_STACK_SIZE = 100;
      const UNDO_SAVE_DELAY = 1000; // 1ì´ˆ í›„ undo ìŠ¤íƒì— ì €ì¥
      
      // ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° ì‹œìŠ¤í…œ
      let previewUpdateTimer = null;
      const PREVIEW_UPDATE_DELAY = 500; // 500ms í›„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
      
      // ëª¨ë‹¬ ìš”ì†Œë“¤
      const apiKeyModal = document.getElementById('api-key-modal');
      const apiKeyInput = document.getElementById('api-key-input');
      const aiProviderSelect = document.getElementById('ai-provider-select');
      const aiModelSelect = document.getElementById('ai-model-select');
      const customEndpointGroup = document.getElementById('custom-endpoint-group');
      const customEndpointInput = document.getElementById('custom-endpoint-input');
      const showApiKeyBtn = document.getElementById('show-api-key');
      const saveApiKeyBtn = document.getElementById('save-api-key');
      const cancelApiKeyBtn = document.getElementById('cancel-api-key');
      const closeModalBtn = apiKeyModal.querySelector('.close');
      
      // ë„ì›€ë§ ëª¨ë‹¬ ìš”ì†Œë“¤
      const helpModal = document.getElementById('help-modal');
      const closeHelpBtn = document.getElementById('close-help');
      const closeHelpModalBtn = helpModal.querySelector('.close');
        
        // ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ (ì„œë²„ ì½”ë“œì™€ ë™ì¼)
        const defaultContinuePrompt = `ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ ê¸€ì“°ê¸° ë„êµ¬ì…ë‹ˆë‹¤. ì»¤ì„œ ìœ„ì¹˜ì˜ êµ¬ì¡°ì  ë§¥ë½ì„ ì •í™•íˆ íŒŒì•…í•˜ê³ , ê·¸ì— ë§ëŠ” ì ì ˆí•œ ë‚´ìš©ì„ ì œì•ˆí•´ì£¼ì„¸ìš”.

<ì»¤ì„œì•ë‚´ìš©>
{beforeCursor}
</ì»¤ì„œì•ë‚´ìš©>

<ì»¤ì„œë’¤ë‚´ìš©>
{afterCursor}
</ì»¤ì„œë’¤ë‚´ìš©>

<ì „ì²´ë¬¸ì„œ>
{text}
</ì „ì²´ë¬¸ì„œ>

ìœ„ ì •ë³´ë¥¼ ì°¸ê³ í•˜ì—¬ ì»¤ì„œ ìœ„ì¹˜ì— ì ì ˆí•œ ë‚´ìš©ì„ ì œì•ˆí•´ì£¼ì„¸ìš”. ì»¤ì„œ ì• ë‚´ìš©ì˜ êµ¬ì¡°ì™€ ë§¥ë½ì„ ë©´ë°€íˆ ë¶„ì„í•˜ì—¬ ê°€ì¥ ìì—°ìŠ¤ëŸ¬ìš´ í›„ì† ë‚´ìš©ì„ ìƒì„±í•˜ì„¸ìš”.`;
        
        const defaultImprovePrompt = `ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ ê¸€ì“°ê¸° ë„êµ¬ì…ë‹ˆë‹¤. ì„ íƒëœ í…ìŠ¤íŠ¸ì˜ í•µì‹¬ ì˜ë„ì™€ ë©”ì‹œì§€ë¥¼ ë³´ì¡´í•˜ë©´ì„œ ë” íš¨ê³¼ì ì¸ í‘œí˜„ìœ¼ë¡œ ê°œì„ í•´ì£¼ì„¸ìš”.

<ì„ íƒëœí…ìŠ¤íŠ¸>
{selectedText}
</ì„ íƒëœí…ìŠ¤íŠ¸>

<ì „ì²´ë¬¸ì„œ>
{text}
</ì „ì²´ë¬¸ì„œ>

ìœ„ ì •ë³´ë¥¼ ì°¸ê³ í•˜ì—¬ ì„ íƒëœ í…ìŠ¤íŠ¸ë¥¼ ê°œì„ í•´ì£¼ì„¸ìš”. ì›ë³¸ì˜ ì˜ë„ì™€ í¬ë§·ì„ ë°˜ë“œì‹œ ìœ ì§€í•˜ë©´ì„œ ë¬¸ë²•, ëª…í™•ì„±, í‘œí˜„ë ¥ë§Œ ê°œì„ í•´ì£¼ì„¸ìš”.`;
        
        // AI ìƒíƒœ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        function loadAiSettings() {
          const savedApiKey = localStorage.getItem('ai-api-key');
          const savedProvider = localStorage.getItem('ai-provider') || 'openai';
          const savedModel = localStorage.getItem('ai-model') || 'gpt-4o-mini';
          const savedEndpoint = localStorage.getItem('ai-endpoint') || '';
          const savedCustomModel = localStorage.getItem('ai-custom-model') || '';
          
          // í”„ë¡¬í”„íŠ¸ ì„¤ì • ë¡œë“œ
          const savedContinuePrompt = localStorage.getItem('ai-continue-prompt');
          const savedImprovePrompt = localStorage.getItem('ai-improve-prompt');
          
          if (savedApiKey) {
            userApiKey = savedApiKey;
            aiProvider = savedProvider;
            aiModel = savedModel;
            customEndpoint = savedEndpoint;
            // API í‚¤ê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ í™œì„±í™”
            isAiEnabled = true;
            console.log('ì €ì¥ëœ AI ì„¤ì • ë¡œë“œë¨:', { provider: aiProvider, model: aiModel, endpoint: customEndpoint, customModel: savedCustomModel });
            
            // UIì— ì„¤ì • ë°˜ì˜
            aiProviderSelect.value = savedProvider;
            updateModelOptions(savedProvider);
            aiModelSelect.value = savedModel;
            customEndpointInput.value = savedEndpoint;
            document.getElementById('custom-model-input').value = savedCustomModel;
            handleCustomModelSelection();
            updateProviderUI();
          } else {
            // API í‚¤ê°€ ì—†ìœ¼ë©´ ë¹„í™œì„±í™”
            isAiEnabled = false;
            console.log('ì €ì¥ëœ API í‚¤ê°€ ì—†ìŒ - AI ë¹„í™œì„±í™”');
          }
          
          // í”„ë¡¬í”„íŠ¸ ì„¤ì • UIì— ë°˜ì˜
          const continuePromptTextarea = document.getElementById('continue-prompt');
          const improvePromptTextarea = document.getElementById('improve-prompt');
          
          // ì €ì¥ëœ í”„ë¡¬í”„íŠ¸ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
          continuePromptTextarea.value = savedContinuePrompt || defaultContinuePrompt;
          improvePromptTextarea.value = savedImprovePrompt || defaultImprovePrompt;
          
          updateAiToggleButton();
        }
        
        function saveAiSettings() {
          if (userApiKey) {
            localStorage.setItem('ai-api-key', userApiKey);
            localStorage.setItem('ai-provider', aiProvider);
            localStorage.setItem('ai-model', aiModel);
            localStorage.setItem('ai-endpoint', customEndpoint);
            localStorage.setItem('ai-enabled', isAiEnabled.toString());
          } else {
            localStorage.removeItem('ai-api-key');
            localStorage.removeItem('ai-provider');
            localStorage.removeItem('ai-model');
            localStorage.removeItem('ai-endpoint');
            localStorage.removeItem('ai-enabled');
          }
        }
        
        function updateAiToggleButton() {
          if (isAiEnabled && userApiKey) {
            aiToggleButton.textContent = 'AI í™œì„±í™”';
            aiToggleButton.className = 'ai-enabled';
          } else {
            aiToggleButton.textContent = 'AI ë¹„í™œì„±í™”';
            aiToggleButton.className = 'ai-disabled';
            isAiEnabled = false;
          }
        }
        
        function showApiKeyModal() {
          // ì €ì¥ëœ ì„¤ì •ì„ í¼ì— ë°˜ì˜
          apiKeyInput.value = userApiKey;
          aiProviderSelect.value = aiProvider;
          aiModelSelect.value = aiModel;
          customEndpointInput.value = customEndpoint;
          
          // ì œê³µìì— ë”°ë¥¸ UI ì—…ë°ì´íŠ¸
          updateProviderUI();
          
          apiKeyModal.style.display = 'block';
          apiKeyInput.focus();
        }
        
        function updateProviderUI() {
          const provider = aiProviderSelect.value;
          
          // ì»¤ìŠ¤í…€ ì—”ë“œí¬ì¸íŠ¸ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
          if (provider === 'openai-compatible') {
            customEndpointGroup.style.display = 'block';
          } else {
            customEndpointGroup.style.display = 'none';
          }
          
          // ë„ì›€ë§ í…ìŠ¤íŠ¸ ë³€ê²½
          document.querySelectorAll('.api-key-help > div').forEach(div => {
            div.style.display = 'none';
          });
          document.getElementById(`help-text-${provider}`).style.display = 'block';
          
          // ëª¨ë¸ ëª©ë¡ ì—…ë°ì´íŠ¸
          updateModelOptions(provider);
        }
        
        function updateModelOptions(provider) {
          // ê¸°ì¡´ ì˜µì…˜ë“¤ ì œê±°
          aiModelSelect.innerHTML = '';
          
          let models = [];
          switch (provider) {
            case 'openai':
              models = [
                { value: 'gpt-4o', text: 'GPT-4o (gpt-4o) - ìµœì‹ ', api: 'gpt-4o' },
                { value: 'gpt-4o-mini', text: 'GPT-4o Mini (gpt-4o-mini) - ë¹ ë¦„', api: 'gpt-4o-mini' },
                { value: 'o3-mini', text: 'o3 Mini (o3-mini) - ì¶”ë¡  ì „ë¬¸', api: 'o3-mini' },
                { value: 'custom', text: 'ì§ì ‘ ì…ë ¥...', api: 'custom' }
              ];
              break;
            case 'anthropic':
              models = [
                { value: 'claude-3-7-sonnet', text: 'Claude 3.7 Sonnet (claude-3-7-sonnet-20250219) - ìµœì‹ ', api: 'claude-3-7-sonnet-20250219' },
                { value: 'claude-3-5-sonnet', text: 'Claude 3.5 Sonnet (claude-3-5-sonnet-20241022) - ì¸ê¸°', api: 'claude-3-5-sonnet-20241022' },
                { value: 'claude-3-5-haiku', text: 'Claude 3.5 Haiku (claude-3-5-haiku-20241022) - ë¹ ë¦„', api: 'claude-3-5-haiku-20241022' },
                { value: 'custom', text: 'ì§ì ‘ ì…ë ¥...', api: 'custom' }
              ];
              break;
            case 'google':
              models = [
                { value: 'gemini-2-5-pro', text: 'Gemini 2.5 Pro (gemini-2.5-pro) - ìµœì‹ ', api: 'gemini-2.5-pro' },
                { value: 'gemini-2-5-flash', text: 'Gemini 2.5 Flash (gemini-2.5-flash) - ê· í˜•', api: 'gemini-2.5-flash' },
                { value: 'gemini-2-0-flash', text: 'Gemini 2.0 Flash (gemini-2.0-flash) - ì°¨ì„¸ëŒ€', api: 'gemini-2.0-flash' },
                { value: 'custom', text: 'ì§ì ‘ ì…ë ¥...', api: 'custom' }
              ];
              break;
            case 'openai-compatible':
              models = [
                { value: 'gpt-4o', text: 'GPT-4o í˜¸í™˜ (gpt-4o)', api: 'gpt-4o' },
                { value: 'gpt-3.5-turbo', text: 'GPT-3.5 Turbo í˜¸í™˜ (gpt-3.5-turbo)', api: 'gpt-3.5-turbo' },
                { value: 'llama-3.1-70b', text: 'Llama 3.1 70B (llama-3.1-70b-instruct)', api: 'llama-3.1-70b-instruct' },
                { value: 'custom', text: 'ì§ì ‘ ì…ë ¥...', api: 'custom' }
              ];
              break;
          }
          
          // ìƒˆ ì˜µì…˜ë“¤ ì¶”ê°€
          models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.value;
            option.textContent = model.text;
            option.dataset.api = model.api;
            aiModelSelect.appendChild(option);
          });
          
          // ì €ì¥ëœ ëª¨ë¸ì´ ëª©ë¡ì— ìˆìœ¼ë©´ ì„ íƒ
          if (models.find(m => m.value === aiModel)) {
            aiModelSelect.value = aiModel;
          } else {
            // ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ëª¨ë¸ ì„ íƒ
            aiModelSelect.value = models[0].value;
          }
          
          // ì§ì ‘ ì…ë ¥ ê´€ë ¨ ì²˜ë¦¬
          handleCustomModelSelection();
        }
        
        function handleCustomModelSelection() {
          const customModelGroup = document.getElementById('custom-model-group');
          const customModelInput = document.getElementById('custom-model-input');
          
          if (aiModelSelect.value === 'custom') {
            customModelGroup.style.display = 'block';
            customModelInput.focus();
          } else {
            customModelGroup.style.display = 'none';
          }
        }
        
        function getActualModelName() {
          const selectedOption = aiModelSelect.selectedOptions[0];
          if (aiModelSelect.value === 'custom') {
            const customModelInput = document.getElementById('custom-model-input');
            const customModelName = customModelInput.value.trim() || localStorage.getItem('ai-custom-model') || 'gpt-4o-mini';
            return customModelName;
          }
          return selectedOption.dataset.api || selectedOption.value;
        }
        
        function hideApiKeyModal() {
          apiKeyModal.style.display = 'none';
          apiKeyInput.value = '';
        }
        
        function showHelpModal() {
          helpModal.style.display = 'block';
        }
        
        function hideHelpModal() {
          helpModal.style.display = 'none';
        }
        
        function togglePasswordVisibility() {
          if (apiKeyInput.type === 'password') {
            apiKeyInput.type = 'text';
            showApiKeyBtn.textContent = 'ğŸ™ˆ';
          } else {
            apiKeyInput.type = 'password';
            showApiKeyBtn.textContent = 'ğŸ‘';
          }
        }
        
        // Undo/Redo ì‹œìŠ¤í…œ í•¨ìˆ˜ë“¤
        function saveToUndoStack() {
          if (isUndoRedo) return; // undo/redo ë™ì‘ ì¤‘ì—ëŠ” ìŠ¤íƒì— ì €ì¥í•˜ì§€ ì•ŠìŒ
          
          const currentState = {
            content: editor.value,
            selectionStart: editor.selectionStart,
            selectionEnd: editor.selectionEnd,
            timestamp: Date.now()
          };
          
          // ì´ì „ ìƒíƒœì™€ ë™ì¼í•˜ë©´ ì €ì¥í•˜ì§€ ì•ŠìŒ
          if (undoStack.length > 0) {
            const lastState = undoStack[undoStack.length - 1];
            if (lastState.content === currentState.content) {
              return;
            }
          }
          
          undoStack.push(currentState);
          
          // ìŠ¤íƒ í¬ê¸° ì œí•œ
          if (undoStack.length > MAX_UNDO_STACK_SIZE) {
            undoStack.shift();
          }
          
          // ìƒˆë¡œìš´ ë³€ê²½ì´ ìˆìœ¼ë©´ redo ìŠ¤íƒ ì´ˆê¸°í™”
          redoStack = [];
          
          console.log('Undo stack saved:', undoStack.length, 'states');
        }
        
        function undo() {
          if (undoStack.length === 0) return false;
          
          // í˜„ì¬ ìƒíƒœë¥¼ redo ìŠ¤íƒì— ì €ì¥
          const currentState = {
            content: editor.value,
            selectionStart: editor.selectionStart,
            selectionEnd: editor.selectionEnd,
            timestamp: Date.now()
          };
          redoStack.push(currentState);
          
          // ì´ì „ ìƒíƒœë¡œ ë³µì›
          const prevState = undoStack.pop();
          isUndoRedo = true;
          
          editor.value = prevState.content;
          editor.selectionStart = prevState.selectionStart;
          editor.selectionEnd = prevState.selectionEnd;
          
          isUndoRedo = false;
          
          // Undo í›„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
          if (document.body.classList.contains('editor-mode')) {
            schedulePreviewUpdate();
          }
          
          console.log('Undo executed, remaining states:', undoStack.length);
          return true;
        }
        
        function redo() {
          if (redoStack.length === 0) return false;
          
          // í˜„ì¬ ìƒíƒœë¥¼ undo ìŠ¤íƒì— ì €ì¥
          const currentState = {
            content: editor.value,
            selectionStart: editor.selectionStart,
            selectionEnd: editor.selectionEnd,
            timestamp: Date.now()
          };
          undoStack.push(currentState);
          
          // ë‹¤ìŒ ìƒíƒœë¡œ ë³µì›
          const nextState = redoStack.pop();
          isUndoRedo = true;
          
          editor.value = nextState.content;
          editor.selectionStart = nextState.selectionStart;
          editor.selectionEnd = nextState.selectionEnd;
          
          isUndoRedo = false;
          
          // Redo í›„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
          if (document.body.classList.contains('editor-mode')) {
            schedulePreviewUpdate();
          }
          
          console.log('Redo executed, remaining redo states:', redoStack.length);
          return true;
        }
        
        function updateEditorValue(newValue, newSelectionStart = null, newSelectionEnd = null) {
          // ë³€ê²½ ì „ ìƒíƒœë¥¼ undo ìŠ¤íƒì— ì €ì¥
          saveToUndoStack();
          
          // ìƒˆ ê°’ ì„¤ì •
          editor.value = newValue;
          
          // ì»¤ì„œ ìœ„ì¹˜ ì„¤ì •
          if (newSelectionStart !== null) {
            editor.selectionStart = newSelectionStart;
            editor.selectionEnd = newSelectionEnd !== null ? newSelectionEnd : newSelectionStart;
          }
          
          // input ì´ë²¤íŠ¸ ë°œìƒì‹œì¼œì„œ ë‹¤ë¥¸ ë¦¬ìŠ¤ë„ˆë“¤ì´ ë°˜ì‘í•˜ë„ë¡ í•¨
          editor.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        // ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜ë“¤
        async function updatePreview() {
          if (!editor || !editorInitialized) return;
          
          try {
            const markdown = editor.value;
            const response = await fetch('/api/render', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ markdown })
            });
            
            if (!response.ok) {
              console.error('ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', response.status);
              return;
            }
            
            const rendered = await response.json();
            
            // ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ ì—…ë°ì´íŠ¸
            const contentWrapper = document.querySelector('.content-wrapper');
            const tocNav = document.querySelector('#toc-nav');
            
            if (contentWrapper) {
              contentWrapper.innerHTML = rendered.contentHtml;
              
              // ì• ë‹ˆë©”ì´ì…˜ ë‹¤ì‹œ ì ìš©
              initAnimations();
            }
            
            if (tocNav) {
              tocNav.innerHTML = rendered.tocHtml;
            }
            
            console.log('ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ ì™„ë£Œ');
          } catch (error) {
            console.error('ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:', error);
          }
        }
        
        function schedulePreviewUpdate() {
          clearTimeout(previewUpdateTimer);
          previewUpdateTimer = setTimeout(() => {
            updatePreview();
          }, PREVIEW_UPDATE_DELAY);
        }
        
        // AI ì¶”ì²œ í•¨ìˆ˜ë“¤
      async function fetchAISuggestions(text, cursorPosition, mode = 'continue', selectedText = '') {
        // AIê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì¶”ì²œí•˜ì§€ ì•ŠìŒ
        console.log('AI ì¶”ì²œ ìƒíƒœ í™•ì¸:', { isAiEnabled, hasApiKey: !!userApiKey, provider: aiProvider, model: aiModel });
        
        if (!isAiEnabled || !userApiKey) {
          console.log('AI ì¶”ì²œ ì°¨ë‹¨ë¨:', { isAiEnabled, hasApiKey: !!userApiKey });
          return null;
        }
        
        try {
          console.log('AI API í˜¸ì¶œ ì‹œì‘:', { mode, selectedText, provider: aiProvider, model: aiModel });
          const response = await fetch('/api/ai-suggest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              text, 
              cursorPosition, 
              mode, 
              selectedText,
              apiKey: userApiKey,
              provider: aiProvider,
              model: getActualModelName(),
              endpoint: customEndpoint,
              customContinuePrompt: localStorage.getItem('ai-continue-prompt') || '',
              customImprovePrompt: localStorage.getItem('ai-improve-prompt') || ''
            })
          });
          
          console.log('API ì‘ë‹µ ìƒíƒœ:', response.status);
          
          const data = await response.json();
          console.log('API ì‘ë‹µ ë°ì´í„°:', data);
          
          if (!response.ok) {
            console.warn('API ì˜¤ë¥˜:', data.error);
            // ì„œë¹„ìŠ¤ ì—ëŸ¬ì—¬ë„ fallback ì¶”ì²œì´ ìˆìœ¼ë©´ ì‚¬ìš©
            return data.suggestions || [];
          }
          
          return data.suggestions || [];
        } catch (error) {
          console.error('AI suggestions ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
          // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ì¶”ì²œ ì œê³µ
          if (mode === 'improve') {
            return ['ë” ëª…í™•í•˜ê²Œ í‘œí˜„', 'êµ¬ì²´ì ì¸ ì„¤ëª… ì¶”ê°€', 'ê°„ê²°í•˜ê²Œ ì •ë¦¬'];
          } else {
            return ['ì„ ë” ì„¤ëª…í•˜ë©´', 'ì— ëŒ€í•œ ì˜ˆì‹œëŠ”', 'ì˜ ì¥ì ì€'];
          }
        }
      }
      

      
      function updateGhostText() {
        // ê³ ìŠ¤íŠ¸ í…ìŠ¤íŠ¸ëŠ” ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (ì¶”ì²œ íŒ¨ë„ë§Œ ì‚¬ìš©)
        ghostText.style.display = 'none';
      }
      
      function showSuggestionPanel() {
        if (currentSuggestions.length === 0) return;
        
        suggestionPanel.innerHTML = '';
        
        // ëª¨ë“œ í‘œì‹œ í—¤ë” ì¶”ê°€
        const header = document.createElement('div');
        header.style.padding = '8px 12px';
        header.style.borderBottom = '1px solid #eee';
        header.style.fontSize = '12px';
        header.style.color = '#666';
        header.style.fontWeight = 'bold';
        header.style.backgroundColor = '#f8f8f8';
        header.textContent = suggestionMode === 'improve' 
          ? `ğŸ“ ê¸€ì“°ê¸° ê°œì„ : "${selectedTextForImprovement.substring(0, 20)}${selectedTextForImprovement.length > 20 ? '...' : ''}"` 
          : 'âœï¸ ê¸€ì“°ê¸° ì§€ì›';
        suggestionPanel.appendChild(header);
        
        currentSuggestions.forEach((suggestion, index) => {
          const item = document.createElement('div');
          item.className = 'suggestion-item';
          if (index === selectedSuggestionIndex) {
            item.classList.add('selected');
          }
          item.textContent = suggestion;
          item.addEventListener('click', () => applySuggestion(index));
          suggestionPanel.appendChild(item);
        });
        
        // íŒ¨ë„ì„ ì—ë””í„° í•˜ë‹¨ ì¤‘ì•™ì— í‘œì‹œ
        suggestionPanel.style.display = 'block';
        suggestionPanel.style.left = '50%';
        suggestionPanel.style.bottom = '20px';
        suggestionPanel.style.transform = 'translateX(-50%)';
        suggestionPanel.style.maxWidth = '450px';
        suggestionPanel.style.minWidth = '350px';
      }
      
      function hideSuggestionPanel() {
        suggestionPanel.style.display = 'none';
        isShowingSuggestion = false;
        ghostText.style.display = 'none';
      }
      
      function showLoadingPanel() {
        suggestionPanel.innerHTML = '';
        
        // ë¡œë”© í—¤ë”
        const header = document.createElement('div');
        header.style.padding = '12px';
        header.style.textAlign = 'center';
        header.style.fontSize = '14px';
        header.style.color = '#666';
        header.style.backgroundColor = '#f8f8f8';
        header.style.borderRadius = '4px';
        
        // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì•„ì´ì½˜
        const icon = document.createElement('div');
        icon.style.display = 'inline-block';
        icon.style.marginRight = '8px';
        icon.innerHTML = 'ğŸ¤–';
        icon.style.animation = 'bounce 1s infinite';
        
        // ë¡œë”© í…ìŠ¤íŠ¸
        const text = document.createElement('span');
        text.textContent = 'AIê°€ ê¸€ì“°ê¸°ë¥¼ ë„ì™€ë“œë¦¬ê³  ìˆìŠµë‹ˆë‹¤...';
        
        header.appendChild(icon);
        header.appendChild(text);
        suggestionPanel.appendChild(header);
        
        // íŒ¨ë„ í‘œì‹œ
        suggestionPanel.style.display = 'block';
        suggestionPanel.style.left = '50%';
        suggestionPanel.style.bottom = '20px';
        suggestionPanel.style.transform = 'translateX(-50%)';
        suggestionPanel.style.maxWidth = '350px';
        suggestionPanel.style.minWidth = '300px';
      }
      
      function applySuggestion(index = selectedSuggestionIndex) {
        if (currentSuggestions.length === 0) return;
        
        const suggestion = currentSuggestions[index];
        console.log('ì¶”ì²œ ì ìš©:', { mode: suggestionMode, suggestion });
        
        if (suggestionMode === 'improve') {
          // ê°œì„  ëª¨ë“œ: ì„ íƒëœ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì²œìœ¼ë¡œ ëŒ€ì²´
          const selectionStart = editor.selectionStart;
          const selectionEnd = editor.selectionEnd;
          const text = editor.value;
          
          const textBefore = text.substring(0, selectionStart);
          const textAfter = text.substring(selectionEnd);
          
          // ì„ íƒëœ ë¶€ë¶„ì„ ì¶”ì²œìœ¼ë¡œ ëŒ€ì²´
          const newText = textBefore + suggestion + textAfter;
          const newCursorPos = selectionStart + suggestion.length;
          
          updateEditorValue(newText, newCursorPos, newCursorPos);
          
          // AI ì¶”ì²œ ì ìš© í›„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
          schedulePreviewUpdate();
          
          console.log('í…ìŠ¤íŠ¸ ëŒ€ì²´ ì™„ë£Œ:', {
            before: selectedTextForImprovement,
            after: suggestion,
            newCursorPos
          });
        } else {
          // ì—°ì† ì‘ì„± ëª¨ë“œ: ì»¤ì„œ ìœ„ì¹˜ì— ì¶”ì²œ ì¶”ê°€
          const cursorPos = editor.selectionStart;
          const textBefore = editor.value.substring(0, cursorPos);
          const textAfter = editor.value.substring(cursorPos);
          
          // ìƒˆë¡œìš´ í…ìŠ¤íŠ¸ë¡œ ì—…ë°ì´íŠ¸
          const newText = textBefore + suggestion + textAfter;
          const newCursorPos = cursorPos + suggestion.length;
          
          updateEditorValue(newText, newCursorPos, newCursorPos);
          
          // AI ì¶”ì²œ ì ìš© í›„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
          schedulePreviewUpdate();
          
          console.log('í…ìŠ¤íŠ¸ ì¶”ê°€ ì™„ë£Œ:', {
            suggestion,
            newCursorPos
          });
        }
        
        // ì¶”ì²œ ìƒíƒœ ì´ˆê¸°í™”
        hideSuggestionPanel();
        currentSuggestions = [];
        isShowingSuggestion = false;
        suggestionMode = 'continue';
        selectedTextForImprovement = '';
        
        // í¬ì»¤ìŠ¤ í™•ì‹¤íˆ ìœ ì§€
        setTimeout(() => {
          editor.focus();
        }, 0);
      }
      
      function selectNextSuggestion() {
        if (currentSuggestions.length === 0) return;
        selectedSuggestionIndex = (selectedSuggestionIndex + 1) % currentSuggestions.length;
        showSuggestionPanel(); // íŒ¨ë„ ì—…ë°ì´íŠ¸ë§Œ
      }
      
      function selectPrevSuggestion() {
        if (currentSuggestions.length === 0) return;
        selectedSuggestionIndex = selectedSuggestionIndex === 0 
          ? currentSuggestions.length - 1 
          : selectedSuggestionIndex - 1;
        showSuggestionPanel(); // íŒ¨ë„ ì—…ë°ì´íŠ¸ë§Œ
      }
      
      // ìˆ˜ë™ ì¶”ì²œ ìš”ì²­ í•¨ìˆ˜
      async function requestSuggestions() {
        const text = editor.value;
        const selectionStart = editor.selectionStart;
        const selectionEnd = editor.selectionEnd;
        const selectedText = text.substring(selectionStart, selectionEnd);
        
        // ë¡œë”© íŒ¨ë„ í‘œì‹œ
        showLoadingPanel();
        
        try {
          // ì„ íƒëœ í…ìŠ¤íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
          if (selectedText && selectedText.trim().length > 0) {
            // ê°œì„  ëª¨ë“œ
            suggestionMode = 'improve';
            selectedTextForImprovement = selectedText;
            
            console.log('ê°œì„  ëª¨ë“œ AI ì¶”ì²œ ìš”ì²­:', {
              selectedText: selectedText.trim(),
              textLength: text.length
            });
            
            const suggestions = await fetchAISuggestions(text, selectionStart, 'improve', selectedText);
            console.log('ë°›ì€ ê°œì„  ì¶”ì²œ:', suggestions);
            
            if (suggestions && suggestions.length > 0) {
              currentSuggestions = suggestions;
              selectedSuggestionIndex = 0;
              isShowingSuggestion = true;
              showSuggestionPanel();
              console.log('ê°œì„  ì¶”ì²œ íŒ¨ë„ í‘œì‹œë¨');
            } else {
              console.log('ê°œì„  ì¶”ì²œì´ ë¹„ì–´ìˆìŒ');
              hideSuggestionPanel();
            }
        } else {
          // ì—°ì† ì‘ì„± ëª¨ë“œ
          suggestionMode = 'continue';
          selectedTextForImprovement = '';
          
          const cursorPos = selectionStart;
          const textBefore = text.substring(0, cursorPos);
          const currentLine = textBefore.split('\n').pop();
          
          console.log('ì—°ì† ì‘ì„± ëª¨ë“œ AI ì¶”ì²œ ìš”ì²­:', {
            currentLineLength: currentLine.trim().length,
            cursorPos,
            textLength: text.length
          });
          
          // í•­ìƒ AI ì¶”ì²œ ìš”ì²­ (ì»¤ì„œ ì„ íƒ ì—†ì–´ë„ ë™ì‘)
          console.log('AI ì¶”ì²œ ìš”ì²­ ì¤‘...');
          const suggestions = await fetchAISuggestions(text, cursorPos, 'continue');
          console.log('ë°›ì€ ì—°ì† ì¶”ì²œ:', suggestions);
          
          if (suggestions && suggestions.length > 0) {
            currentSuggestions = suggestions;
            selectedSuggestionIndex = 0;
            isShowingSuggestion = true;
            showSuggestionPanel();
            console.log('ì—°ì† ì¶”ì²œ íŒ¨ë„ í‘œì‹œë¨');
          } else {
            console.log('ì—°ì† ì¶”ì²œì´ ë¹„ì–´ìˆìŒ');
            hideSuggestionPanel();
          }
        }
        } catch (error) {
          console.error('AI ì¶”ì²œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
          hideSuggestionPanel();
          alert('AI ì¶”ì²œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
        }
      }
      
      // ìë™ ì¶”ì²œì€ ë¹„í™œì„±í™” (í…ìŠ¤íŠ¸ ë³€ê²½ ì‹œ ì¶”ì²œ ìˆ¨ê¸°ê¸°ë§Œ)
      async function handleTextChange() {
        // íƒ€ì´í•‘ ì¤‘ì—ëŠ” ì¶”ì²œ íŒ¨ë„ ìˆ¨ê¸°ê¸°
        if (isShowingSuggestion) {
          hideSuggestionPanel();
          currentSuggestions = [];
          isShowingSuggestion = false;
        }
        
        // ë””ë°”ìš´ìŠ¤ undo ì €ì¥ (undo/redo ë™ì‘ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ)
        if (!isUndoRedo) {
          clearTimeout(undoSaveTimer);
          undoSaveTimer = setTimeout(() => {
            saveToUndoStack();
          }, UNDO_SAVE_DELAY);
        }
        
        // ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (ì—ë””í„° ëª¨ë“œì¼ ë•Œë§Œ)
        if (document.body.classList.contains('editor-mode')) {
          schedulePreviewUpdate();
        }
      }

              if (editorToggle) {
          editorToggle.addEventListener('click', async () => {
            document.body.classList.toggle('editor-mode');
            editorToggle.classList.toggle('active');
            
            if (document.body.classList.contains('editor-mode') && !editorInitialized) {
              try {
                const response = await fetch(`/api/get-file?filename=${encodeURIComponent(currentFile)}`);
                const data = await response.json();
                editor.value = data.content || '';
                editorInitialized = true;
                
                // íŒŒì¼ ë¡œë”© ì™„ë£Œ í›„ ì´ˆê¸° ìƒíƒœë¥¼ undo ìŠ¤íƒì— ì €ì¥
                undoStack = [];
                redoStack = [];
                saveToUndoStack();
                
                // ì—ë””í„° ëª¨ë“œì¼ ë•Œ ì´ˆê¸° ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                if (document.body.classList.contains('editor-mode')) {
                  schedulePreviewUpdate();
                }
                
                // AI ì¶”ì²œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
                initAIFeatures();
              } catch (error) {
                console.error('Error loading file:', error);
                editor.value = 'Error loading file content.';
              }
            }
          });
        }
        
        function initAIFeatures() {
          // AI ì„¤ì • ë¡œë“œ
          console.log('AI ê¸°ëŠ¥ ì´ˆê¸°í™” ì‹œì‘');
          loadAiSettings();
          console.log('AI ì„¤ì • ë¡œë“œ ì™„ë£Œ:', { isAiEnabled, hasApiKey: !!userApiKey, provider: aiProvider, model: aiModel });
          
          // ë„ì›€ë§ ë²„íŠ¼ ì´ë²¤íŠ¸
          helpButton.addEventListener('click', () => {
            showHelpModal();
          });
          
          // AI í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸
          aiToggleButton.addEventListener('click', () => {
            if (isAiEnabled && userApiKey) {
              // AI ë¹„í™œì„±í™”
              isAiEnabled = false;
              updateAiToggleButton();
              saveAiSettings();
              hideSuggestionPanel(); // í˜„ì¬ í‘œì‹œëœ ì¶”ì²œ ìˆ¨ê¸°ê¸°
            } else {
              // API í‚¤ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
              showApiKeyModal();
            }
          });
          
          // ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
          closeModalBtn.addEventListener('click', hideApiKeyModal);
          cancelApiKeyBtn.addEventListener('click', hideApiKeyModal);
          showApiKeyBtn.addEventListener('click', togglePasswordVisibility);
          
          // AI ì œê³µì ë³€ê²½ ì‹œ UI ì—…ë°ì´íŠ¸
          aiProviderSelect.addEventListener('change', updateProviderUI);
          
          // AI ëª¨ë¸ ì„ íƒ ë³€ê²½ ì‹œ ì§ì ‘ ì…ë ¥ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
          aiModelSelect.addEventListener('change', handleCustomModelSelection);
          
          // ë„ì›€ë§ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
          closeHelpBtn.addEventListener('click', hideHelpModal);
          closeHelpModalBtn.addEventListener('click', hideHelpModal);
          
          // í”„ë¡¬í”„íŠ¸ ì´ˆê¸°í™” ë²„íŠ¼ë“¤
          const resetContinuePromptBtn = document.getElementById('reset-continue-prompt');
          const resetImprovePromptBtn = document.getElementById('reset-improve-prompt');
          
          resetContinuePromptBtn.addEventListener('click', () => {
            document.getElementById('continue-prompt').value = defaultContinuePrompt;
          });
          
          resetImprovePromptBtn.addEventListener('click', () => {
            document.getElementById('improve-prompt').value = defaultImprovePrompt;
          });
          
          // API í‚¤ ì €ì¥ ë²„íŠ¼
          saveApiKeyBtn.addEventListener('click', () => {
            const apiKey = apiKeyInput.value.trim();
            const provider = aiProviderSelect.value;
            const model = aiModelSelect.value;
            const endpoint = customEndpointInput.value.trim();
            const customModel = document.getElementById('custom-model-input').value.trim();
            
            // í”„ë¡¬í”„íŠ¸ ê°€ì ¸ì˜¤ê¸°
            const continuePrompt = document.getElementById('continue-prompt').value.trim();
            const improvePrompt = document.getElementById('improve-prompt').value.trim();
            
            // API í‚¤ ìœ íš¨ì„± ê²€ì‚¬
            if (apiKey.length < 5) {
              alert('ìœ íš¨í•œ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
              return;
            }
            
            // ì§ì ‘ ì…ë ¥ ëª¨ë¸ ê²€ì‚¬
            if (model === 'custom' && !customModel) {
              alert('ì§ì ‘ ì…ë ¥ ëª¨ë¸ì„ ì„ íƒí–ˆì„ ë•ŒëŠ” ëª¨ë¸ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
              document.getElementById('custom-model-input').focus();
              return;
            }
            
            // OpenAI í˜¸í™˜ APIì¸ ê²½ìš° ì—”ë“œí¬ì¸íŠ¸ í•„ìˆ˜
            if (provider === 'openai-compatible' && !endpoint) {
              alert('OpenAI í˜¸í™˜ APIë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
              return;
            }
            
            // ì„¤ì • ì €ì¥
            userApiKey = apiKey;
            aiProvider = provider;
            aiModel = model;
            customEndpoint = endpoint;
            isAiEnabled = true;
            
            // ì»¤ìŠ¤í…€ ëª¨ë¸ëª…ë„ ì €ì¥
            if (model === 'custom') {
              localStorage.setItem('ai-custom-model', customModel);
            }
            
            // í”„ë¡¬í”„íŠ¸ ì €ì¥ (ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ì™€ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ ì €ì¥)
            if (continuePrompt && continuePrompt !== defaultContinuePrompt) {
              localStorage.setItem('ai-continue-prompt', continuePrompt);
            } else if (continuePrompt === defaultContinuePrompt) {
              localStorage.removeItem('ai-continue-prompt');
            }
            
            if (improvePrompt && improvePrompt !== defaultImprovePrompt) {
              localStorage.setItem('ai-improve-prompt', improvePrompt);
            } else if (improvePrompt === defaultImprovePrompt) {
              localStorage.removeItem('ai-improve-prompt');
            }
            
            updateAiToggleButton();
            saveAiSettings();
            hideApiKeyModal();
          });
          
          // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
          apiKeyModal.addEventListener('click', (e) => {
            if (e.target === apiKeyModal) {
              hideApiKeyModal();
            }
          });
          
          helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal) {
              hideHelpModal();
            }
          });
          
          // Enter í‚¤ë¡œ API í‚¤ ì €ì¥
          apiKeyInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              saveApiKeyBtn.click();
            } else if (e.key === 'Escape') {
              hideApiKeyModal();
            }
          });
          
          // ESC í‚¤ë¡œ ë„ì›€ë§ ëª¨ë‹¬ ë‹«ê¸°
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && helpModal.style.display === 'block') {
              hideHelpModal();
            }
          });
          
          // í…ìŠ¤íŠ¸ ì…ë ¥ ì´ë²¤íŠ¸
          editor.addEventListener('input', handleTextChange);
          
          // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ (ì—ë””í„°ì—ë§Œ ì ìš©)
          editor.addEventListener('keydown', (e) => {
            // ì—ë””í„°ì— í¬ì»¤ìŠ¤ê°€ ìˆì„ ë•Œë§Œ ì²˜ë¦¬
            if (document.activeElement !== editor) return;
            
            console.log('ì—ë””í„° í‚¤ë³´ë“œ ì´ë²¤íŠ¸:', e.key, 'isShowingSuggestion:', isShowingSuggestion, 'suggestions:', currentSuggestions.length);
            
            // Cmd+Z (Undo)
            if (e.metaKey && e.key === 'z' && !e.shiftKey) {
              e.preventDefault();
              e.stopPropagation();
              if (undo()) {
                console.log('Undo ì‹¤í–‰ë¨');
              } else {
                console.log('Undoí•  ë‚´ìš©ì´ ì—†ìŒ');
              }
              return false;
            }
            
            // Cmd+Shift+Z ë˜ëŠ” Cmd+Y (Redo)
            if (e.metaKey && ((e.key === 'z' && e.shiftKey) || e.key === 'y')) {
              e.preventDefault();
              e.stopPropagation();
              if (redo()) {
                console.log('Redo ì‹¤í–‰ë¨');
              } else {
                console.log('Redoí•  ë‚´ìš©ì´ ì—†ìŒ');
              }
              return false;
            }
            
            // Cmd + Ctrl + â†’ (ìš°ì¸¡ í™”ì‚´í‘œ)ë¡œ ì¶”ì²œ ëª©ë¡ í‘œì‹œ
            if (e.metaKey && e.ctrlKey && e.key === 'ArrowRight') {
              e.preventDefault();
              e.stopPropagation();
              
              // AIê°€ í™œì„±í™”ë˜ì–´ ìˆì„ ë•Œë§Œ ë™ì‘
              if (!isAiEnabled || !userApiKey) {
                console.log('AIê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŒ - ì¶”ì²œ ìš”ì²­ ë¬´ì‹œ');
                alert('AI ì¶”ì²œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¨¼ì € í™œì„±í™”í•´ì£¼ì„¸ìš”.');
                return false;
              }
              
              console.log('ìˆ˜ë™ ì¶”ì²œ ìš”ì²­ ì‹œì‘');
              requestSuggestions();
              return false;
            }
            
            // Tab í‚¤ ì²˜ë¦¬ (ì¶”ì²œì´ ìˆìœ¼ë©´ ì™„ì„±, ì—†ìœ¼ë©´ ìŠ¤í˜ì´ìŠ¤ 4ê°œ)
            if (e.key === 'Tab') {
              if (isShowingSuggestion && currentSuggestions.length > 0) {
                // AI ì¶”ì²œ ì™„ì„±
                console.log('Tab í‚¤ë¡œ ì¶”ì²œ ì™„ì„± ì‹œë„');
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                applySuggestion();
                return false;
              } else {
                // ê¸°ë³¸ Tab ë™ì‘: ìŠ¤í˜ì´ìŠ¤ 4ê°œ ì‚½ì…
                e.preventDefault();
                const cursorPos = editor.selectionStart;
                const textBefore = editor.value.substring(0, cursorPos);
                const textAfter = editor.value.substring(editor.selectionEnd);
                
                // ìŠ¤í˜ì´ìŠ¤ 4ê°œ ì‚½ì…
                const newText = textBefore + '    ' + textAfter;
                const newCursorPos = cursorPos + 4;
                
                updateEditorValue(newText, newCursorPos, newCursorPos);
                
                // Tab ìŠ¤í˜ì´ìŠ¤ ì‚½ì… í›„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                schedulePreviewUpdate();
                
                return false;
              }
            }
            
            // ì¶”ì²œ íŒ¨ë„ì´ ì—´ë ¤ìˆì„ ë•Œì˜ ë‹¤ë¥¸ í‚¤ë³´ë“œ ì²˜ë¦¬
            if (isShowingSuggestion && currentSuggestions.length > 0) {
              // â†“ í‚¤ë¡œ ë‹¤ìŒ ì¶”ì²œ
              if (e.key === 'ArrowDown') {
                e.preventDefault();
                e.stopPropagation();
                selectNextSuggestion();
                return false;
              }
              
              // â†‘ í‚¤ë¡œ ì´ì „ ì¶”ì²œ
              if (e.key === 'ArrowUp') {
                e.preventDefault();
                e.stopPropagation();
                selectPrevSuggestion();
                return false;
              }
              
              // Escapeë¡œ ì¶”ì²œ íŒ¨ë„ ë‹«ê¸°
              if (e.key === 'Escape') {
                e.preventDefault();
                hideSuggestionPanel();
                currentSuggestions = [];
                isShowingSuggestion = false;
                return false;
              }
            }
          }, true); // ìº¡ì²˜ ë‹¨ê³„ì—ì„œ ì´ë²¤íŠ¸ ì²˜ë¦¬
          
          // ì „ì—­ í‚¤ë³´ë“œ ì´ë²¤íŠ¸ëŠ” ì œê±° (ì—ë””í„° ì´ë²¤íŠ¸ë¡œ ì¶©ë¶„)
          
          // ì—ë””í„° í¬ì»¤ìŠ¤ í•´ì œ ì‹œ íŒ¨ë„ ìˆ¨ê¸°ê¸°
          editor.addEventListener('blur', () => {
            setTimeout(() => {
              if (!suggestionPanel.contains(document.activeElement)) {
                hideSuggestionPanel();
                currentSuggestions = [];
                isShowingSuggestion = false;
              }
            }, 100);
          });
        }

      if (saveButton) {
        saveButton.addEventListener('click', async () => {
          if (!currentFile) {
            alert('No file specified.');
            return;
          }

          const content = editor.value;
          saveButton.textContent = 'Saving...';
          
          try {
            const response = await fetch('/save-md', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ content, file: currentFile })
            });

            if (!response.ok) {
              throw new Error('Save failed');
            }
          } catch (error) {
            console.error('Error saving:', error);
            alert('Failed to save file.');
          } finally {
            saveButton.textContent = 'Save';
          }
        });
      }

      // Export ê¸°ëŠ¥
      const exportTrigger = document.getElementById('export-trigger');
      const exportOptions = document.getElementById('export-options');
      const exportHtmlBtn = document.getElementById('export-html-btn');
      const exportPdfBtn = document.getElementById('export-pdf-btn');
      const exportMarkdownBtn = document.getElementById('export-markdown-btn');

      if (exportTrigger) {
        exportTrigger.addEventListener('click', (e) => {
          e.stopPropagation();
          exportOptions.style.display = exportOptions.style.display === 'block' ? 'none' : 'block';
        });

        document.addEventListener('click', (e) => {
          if (!exportTrigger.contains(e.target)) {
            exportOptions.style.display = 'none';
          }
        });
      }

      const getMarkdownForExport = async () => {
        if (document.body.classList.contains('editor-mode') && editorInitialized) {
          return editor.value;
        }
        const response = await fetch(`/api/get-file?filename=${encodeURIComponent(currentFile)}`);
        const data = await response.json();
        return data.content || '';
      };

      if (exportHtmlBtn) {
        exportHtmlBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          exportOptions.style.display = 'none';
          try {
            const markdown = await getMarkdownForExport();
            const response = await fetch('/export-html', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ markdown, file: currentFile })
            });
            
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFile.replace('.md', '.html');
            a.click();
            URL.revokeObjectURL(url);
          } catch (error) {
            console.error('Export failed:', error);
            alert('HTML export failed.');
          }
        });
      }

      if (exportPdfBtn) {
        exportPdfBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          exportOptions.style.display = 'none';
          try {
            const markdown = await getMarkdownForExport();
            const response = await fetch('/export-pdf', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ markdown })
            });
            
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFile.replace('.md', '.pdf');
            a.click();
            URL.revokeObjectURL(url);
          } catch (error) {
            console.error('Export failed:', error);
            alert('PDF export failed.');
          }
        });
      }

      if (exportMarkdownBtn) {
        exportMarkdownBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          exportOptions.style.display = 'none';
          try {
            const markdown = await getMarkdownForExport();
            const response = await fetch('/export-markdown', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ markdown, file: currentFile })
            });
            
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFile || 'presentation.md';
            a.click();
            URL.revokeObjectURL(url);
          } catch (error) {
            console.error('Export failed:', error);
            alert('Markdown export failed.');
          }
        });
      }

      // ë¼ì´ë¸Œ ë¦¬ë¡œë“œ
      if (window.location.protocol !== 'https:') {
        try {
          const ws = new WebSocket(`ws://${window.location.host}`);
          ws.onmessage = (event) => {
            if (event.data === 'reload') {
              window.location.reload();
            }
          };
        } catch (error) {
          console.log('WebSocket connection failed (this is normal for exported files)');
        }
      }
    }

    function initLaserPointer() {
      const canvas = document.createElement('canvas');
      canvas.id = 'laser-canvas';
      document.body.appendChild(canvas);
      const ctx = canvas.getContext('2d');

      const resizeCanvas = () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      };
      window.addEventListener('resize', resizeCanvas);
      resizeCanvas();

      const laserToggle = document.getElementById('laser-toggle');
      let isLaserMode = false;
      let isDrawing = false;
      let lastPoint = null;
      const segments = [];

      const toggleLaser = () => {
        isLaserMode = !isLaserMode;
        document.body.classList.toggle('laser-mode-on', isLaserMode);
        if (laserToggle) {
          laserToggle.classList.toggle('active', isLaserMode);
        }
      };

      if (laserToggle) {
        laserToggle.addEventListener('click', toggleLaser);
      }

      document.addEventListener('keydown', (e) => {
        if (e.key.toLowerCase() === 'l') {
          toggleLaser();
        }
      });

      document.addEventListener('mousedown', (e) => {
        if (!isLaserMode) return;
        e.preventDefault();
        isDrawing = true;
        lastPoint = { x: e.clientX, y: e.clientY };
      });

      document.addEventListener('mouseup', () => {
        isDrawing = false;
        lastPoint = null;
      });

      document.addEventListener('mousemove', (e) => {
        if (!isLaserMode || !isDrawing) return;
        
        const currentPoint = { x: e.clientX, y: e.clientY };
        segments.push({
          start: lastPoint,
          end: currentPoint,
          createdAt: Date.now()
        });
        lastPoint = currentPoint;
      });

      function animate() {
        const now = Date.now();
        
        // ì˜¤ë˜ëœ ì„¸ê·¸ë¨¼íŠ¸ ì œê±°
        while (segments.length > 0 && now - segments[0].createdAt > 1000) {
          segments.shift();
        }

        // ìº”ë²„ìŠ¤ ì§€ìš°ê¸°
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ë ˆì´ì € íŠ¸ë ˆì¼ ê·¸ë¦¬ê¸°
        ctx.lineCap = 'round';
        ctx.lineWidth = 3;
        
        segments.forEach(segment => {
          const age = now - segment.createdAt;
          const opacity = Math.max(0, 1 - (age / 1000));
          
          ctx.beginPath();
          ctx.moveTo(segment.start.x, segment.start.y);
          ctx.lineTo(segment.end.x, segment.end.y);
          ctx.strokeStyle = `rgba(255, 50, 50, ${opacity})`;
          ctx.stroke();
        });

        requestAnimationFrame(animate);
      }
      
      animate();
    }

    // === íŒŒì¼ ì ê¸ˆ ê¸°ëŠ¥ ===
    const lockToggle = document.getElementById('lock-toggle');
    const lockIcon = document.getElementById('lock-icon');
    const fileLockModal = document.getElementById('file-lock-modal');
    const fileUnlockModal = document.getElementById('file-unlock-modal');
    
    // Lock modal elements
    const lockPasswordInput = document.getElementById('lock-password-input');
    const lockPasswordConfirm = document.getElementById('lock-password-confirm');
    const setLockPasswordBtn = document.getElementById('set-lock-password');
    const removeLockBtn = document.getElementById('remove-file-lock');
    const cancelLockBtn = document.getElementById('cancel-lock-settings');
    const showLockPasswordBtn = document.getElementById('show-lock-password');
    const showLockPasswordConfirmBtn = document.getElementById('show-lock-password-confirm');
    
    // Unlock modal elements
    const unlockPasswordInput = document.getElementById('unlock-password-input');
    const unlockFileBtn = document.getElementById('unlock-file');
    const cancelUnlockBtn = document.getElementById('cancel-unlock');
    const showUnlockPasswordBtn = document.getElementById('show-unlock-password');
    const unlockError = document.getElementById('unlock-error');
    
    // Close buttons
    const closeLockModalBtn = fileLockModal.querySelector('.close');
    const closeUnlockModalBtn = fileUnlockModal.querySelector('.close');
    
    // íŒŒì¼ ì ê¸ˆ ìƒíƒœ ë³€ìˆ˜
    let isCurrentFileLocked = false;
    let currentFilePassword = null;
    
    // ì ê¸ˆ ìƒíƒœ í™•ì¸ ë° UI ì—…ë°ì´íŠ¸
    function updateLockStatus() {
      if (isCurrentFileLocked) {
        lockToggle.classList.add('locked');
        lockToggle.classList.remove('unlocked');
        lockToggle.title = 'File is locked - Click to manage';
        // ì ê¸´ ìë¬¼ì‡  ì•„ì´ì½˜ìœ¼ë¡œ ë³€ê²½
        lockIcon.innerHTML = '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><circle cx="12" cy="16" r="1"></circle><path d="M7 11V7a5 5 0 0 1 10 0v4"></path>';
      } else {
        lockToggle.classList.add('unlocked');
        lockToggle.classList.remove('locked');
        lockToggle.title = 'File is unlocked - Click to set password';
        // ì—´ë¦° ìë¬¼ì‡  ì•„ì´ì½˜ìœ¼ë¡œ ë³€ê²½
        lockIcon.innerHTML = '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><circle cx="12" cy="16" r="1"></circle><path d="M7 11V7a5 5 0 0 1 5 0v1"></path>';
      }
    }
    
    // ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€
    function togglePasswordVisibility(input, button) {
      if (input.type === 'password') {
        input.type = 'text';
        button.textContent = 'ğŸ™ˆ';
      } else {
        input.type = 'password';
        button.textContent = 'ğŸ‘';
      }
    }
    
    // ëª¨ë‹¬ í‘œì‹œ/ìˆ¨ê¹€ í•¨ìˆ˜ë“¤
    function showFileLockModal() {
      if (isCurrentFileLocked) {
        // ì´ë¯¸ ì ê¸´ íŒŒì¼ì¸ ê²½ìš° ì ê¸ˆ í•´ì œ ë²„íŠ¼ ë³´ì´ê¸°
        removeLockBtn.style.display = 'inline-block';
        setLockPasswordBtn.textContent = 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½';
      } else {
        removeLockBtn.style.display = 'none';
        setLockPasswordBtn.textContent = 'íŒŒì¼ ì ê¸ˆ';
      }
      fileLockModal.style.display = 'block';
      lockPasswordInput.focus();
    }
    
    function hideFileLockModal() {
      fileLockModal.style.display = 'none';
      lockPasswordInput.value = '';
      lockPasswordConfirm.value = '';
      unlockError.style.display = 'none';
    }
    
    function showFileUnlockModal() {
      fileUnlockModal.style.display = 'block';
      unlockPasswordInput.focus();
    }
    
    function hideFileUnlockModal() {
      fileUnlockModal.style.display = 'none';
      unlockPasswordInput.value = '';
      unlockError.style.display = 'none';
    }
    
    // íŒŒì¼ ì ê¸ˆ ì„¤ì •
    async function setFilePassword() {
      const password = lockPasswordInput.value.trim();
      const confirmPassword = lockPasswordConfirm.value.trim();
      
      if (!password || password.length < 4) {
        alert('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }
      
      if (password !== confirmPassword) {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }
      
      try {
        const response = await fetch('/api/set-file-lock', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            filename: getCurrentFilename(),
            password: password 
          })
        });
        
        if (response.ok) {
          isCurrentFileLocked = true;
          currentFilePassword = password;
          updateLockStatus();
          hideFileLockModal();
          alert('íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì ê²¼ìŠµë‹ˆë‹¤.');
        } else {
          alert('íŒŒì¼ ì ê¸ˆ ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('íŒŒì¼ ì ê¸ˆ ì˜¤ë¥˜:', error);
        alert('íŒŒì¼ ì ê¸ˆ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    // íŒŒì¼ ì ê¸ˆ í•´ì œ
    async function removeFilePassword() {
      try {
        const response = await fetch('/api/remove-file-lock', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename: getCurrentFilename() })
        });
        
        if (response.ok) {
          isCurrentFileLocked = false;
          currentFilePassword = null;
          updateLockStatus();
          hideFileLockModal();
          alert('íŒŒì¼ ì ê¸ˆì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
          alert('íŒŒì¼ ì ê¸ˆ í•´ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('íŒŒì¼ ì ê¸ˆ í•´ì œ ì˜¤ë¥˜:', error);
        alert('íŒŒì¼ ì ê¸ˆ í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    // íŒŒì¼ ì ê¸ˆ í•´ì œ (ë¹„ë°€ë²ˆí˜¸ ì…ë ¥)
    async function unlockFile() {
      const password = unlockPasswordInput.value.trim();
      
      if (!password) {
        unlockError.style.display = 'block';
        unlockError.textContent = 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        return;
      }
      
      try {
        const response = await fetch('/api/unlock-file', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            filename: getCurrentFilename(),
            password: password 
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            hideFileUnlockModal();
            // ì ê¸ˆ í•´ì œ í›„ íŒŒì¼ ë‚´ìš© ë‹¤ì‹œ ë¡œë“œ
            const currentFile = new URLSearchParams(window.location.search).get('file');
            if (currentFile) {
              await loadContent(currentFile);
            }
            // ì ê¸ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
            await updateLockStatus();
          } else {
            unlockError.style.display = 'block';
            unlockError.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
          }
        } else {
          unlockError.style.display = 'block';
          unlockError.textContent = 'íŒŒì¼ ì ê¸ˆ í•´ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
        }
      } catch (error) {
        console.error('íŒŒì¼ ì ê¸ˆ í•´ì œ ì˜¤ë¥˜:', error);
        unlockError.style.display = 'block';
        unlockError.textContent = 'íŒŒì¼ ì ê¸ˆ í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      }
    }
    
    // í˜„ì¬ íŒŒì¼ëª… ê°€ì ¸ì˜¤ê¸° (URLì—ì„œ ì¶”ì¶œ)
    function getCurrentFilename() {
      return new URLSearchParams(window.location.search).get('file') || 'index.md';
    }
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    lockToggle.addEventListener('click', () => {
      if (isCurrentFileLocked) {
        showFileLockModal();
      } else {
        showFileLockModal();
      }
    });
    
    // Lock modal events
    setLockPasswordBtn.addEventListener('click', setFilePassword);
    removeLockBtn.addEventListener('click', removeFilePassword);
    cancelLockBtn.addEventListener('click', hideFileLockModal);
    closeLockModalBtn.addEventListener('click', hideFileLockModal);
    
    // Unlock modal events
    unlockFileBtn.addEventListener('click', unlockFile);
    cancelUnlockBtn.addEventListener('click', hideFileUnlockModal);
    closeUnlockModalBtn.addEventListener('click', hideFileUnlockModal);
    
    // Password visibility toggles
    showLockPasswordBtn.addEventListener('click', () => {
      togglePasswordVisibility(lockPasswordInput, showLockPasswordBtn);
    });
    showLockPasswordConfirmBtn.addEventListener('click', () => {
      togglePasswordVisibility(lockPasswordConfirm, showLockPasswordConfirmBtn);
    });
    showUnlockPasswordBtn.addEventListener('click', () => {
      togglePasswordVisibility(unlockPasswordInput, showUnlockPasswordBtn);
    });
    
    // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
    fileLockModal.addEventListener('click', (e) => {
      if (e.target === fileLockModal) {
        hideFileLockModal();
      }
    });
    fileUnlockModal.addEventListener('click', (e) => {
      if (e.target === fileUnlockModal) {
        hideFileUnlockModal();
      }
    });
    
    // Enter í‚¤ ì´ë²¤íŠ¸
    lockPasswordConfirm.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        setFilePassword();
      }
    });
    unlockPasswordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        unlockFile();
      }
    });
    
    // ì´ˆê¸° ì ê¸ˆ ìƒíƒœ í™•ì¸
    async function checkFileInitialLockStatus() {
      try {
        const response = await fetch(`/api/check-file-lock?filename=${getCurrentFilename()}`);
        if (response.ok) {
          const data = await response.json();
          isCurrentFileLocked = data.isLocked;
          updateLockStatus();
        }
      } catch (error) {
        console.error('íŒŒì¼ ì ê¸ˆ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
      }
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì ê¸ˆ ìƒíƒœ í™•ì¸
    checkFileInitialLockStatus();
  </script>
</body>
</html> 